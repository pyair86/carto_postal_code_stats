CREATE TABLE postal_code_polygon AS
SELECT
    id, code, (ST_DUMP(the_geom)).geom::geometry(Polygon,4326) AS the_geom
FROM
    postal_code;


ALTER TABLE postal_code_polygon

    ADD COLUMN
        dumped_pol_id
    int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    ADD CONSTRAINT
        fk_postal_code_polygon_id
        foreign key (id)
    REFERENCES
        postal_code (id),

    ADD CONSTRAINT
        check_unique_code
    UNIQUE (code, dumped_pol_id),

    ADD CONSTRAINT
        check_not_null_geom
    CHECK (the_geom is not null),

    ADD CONSTRAINT
        check_digits_postal_code
    CHECK (code ~* '^[2][8][0-9]{3}$'),

    ADD CONSTRAINT
        check_dims_geom
    CHECK (st_ndims(the_geom) = 2),

    ADD CONSTRAINT
        check_valid_geom
    CHECK (ST_IsValid(the_geom)),

    ADD CONSTRAINT
        check_positive_area
    CHECK (ST_Area(the_geom) > 0),

    ADD CONSTRAINT
        check_srid_geom
    CHECK (st_srid(the_geom) = 4326),

    ADD CONSTRAINT
       check_geotype_geom
    CHECK (geometrytype(the_geom) = 'POLYGON'::text)
    ;

    CREATE INDEX
        mdr_postal_code_geom_idx
    ON
        postal_code_polygon
    USING GIST (the_geom)
    ;